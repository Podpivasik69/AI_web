{#<!DOCTYPE html>#}
{#<html lang="ru">#}
{#<head>#}
{#    <meta charset="UTF-8">#}
{#    <meta name="viewport" content="width=device-width, initial-scale=1.0">#}
{#    <title>AI Image Generator</title>#}
{#    <!-- Bootstrap 5 CSS -->#}
{#    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">#}
{#    <!-- Bootstrap Icons -->#}
{#    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">#}
{#    <style>#}
{#        .gradient-bg {#}
{#            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);#}
{#            min-height: 100vh;#}
{#        }#}
{##}
{#        .main-card {#}
{#            border: none;#}
{#            border-radius: 20px;#}
{#            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);#}
{#            backdrop-filter: blur(10px);#}
{#        }#}
{##}
{#        .nav-custom {#}
{#            background: rgba(255, 255, 255, 0.95);#}
{#            border-radius: 15px;#}
{#            padding: 15px;#}
{#            margin-bottom: 30px;#}
{#            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);#}
{#        }#}
{##}
{#        .nav-custom .nav-link {#}
{#            border-radius: 10px;#}
{#            margin: 0 5px;#}
{#            font-weight: 500;#}
{#            transition: all 0.3s ease;#}
{#        }#}
{##}
{#        .nav-custom .nav-link.active {#}
{#            background: linear-gradient(45deg, #007bff, #0056b3);#}
{#            transform: translateY(-2px);#}
{#            color: white !important;#}
{#        }#}
{##}
{#        .prompt-textarea {#}
{#            border-radius: 12px;#}
{#            border: 2px solid #e9ecef;#}
{#            transition: all 0.3s ease;#}
{#            resize: none;#}
{#        }#}
{##}
{#        .prompt-textarea:focus {#}
{#            border-color: #007bff;#}
{#            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);#}
{#        }#}
{##}
{#        .generate-btn {#}
{#            background: linear-gradient(45deg, #28a745, #20c997);#}
{#            border: none;#}
{#            border-radius: 12px;#}
{#            padding: 12px 30px;#}
{#            font-weight: 600;#}
{#            transition: all 0.3s ease;#}
{#        }#}
{##}
{#        .generate-btn:hover {#}
{#            transform: translateY(-2px);#}
{#            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);#}
{#        }#}
{##}
{#        .progress-custom {#}
{#            height: 25px;#}
{#            border-radius: 12px;#}
{#            background: #f8f9fa;#}
{#            overflow: hidden;#}
{#        }#}
{##}
{#        .progress-bar-custom {#}
{#            background: linear-gradient(45deg, #007bff, #6610f2);#}
{#            transition: width 0.4s ease;#}
{#        }#}
{##}
{#        .result-image {#}
{#            border-radius: 15px;#}
{#            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);#}
{#            transition: transform 0.3s ease;#}
{#        }#}
{##}
{#        .result-image:hover {#}
{#            transform: scale(1.02);#}
{#        }#}
{##}
{#        .form-label {#}
{#            font-weight: 600;#}
{#            color: #495057;#}
{#            margin-bottom: 8px;#}
{#        }#}
{##}
{#        .card-header-custom {#}
{#            background: linear-gradient(45deg, #007bff, #0056b3);#}
{#            color: white;#}
{#            border-radius: 15px 15px 0 0 !important;#}
{#            padding: 20px;#}
{#        }#}
{##}
{#        .stats-number {#}
{#            font-size: 1.8rem;#}
{#            font-weight: bold;#}
{#        }#}
{#    </style>#}
{#</head>#}
{#<body class="gradient-bg">#}
{#<div class="container py-4">#}
{#    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->#}
{#    <nav class="nav-custom">#}
{#        <div class="nav nav-pills justify-content-center">#}
{#            <a class="nav-link active" href="/">#}
{#                <i class="bi bi-palette me-2"></i>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä#}
{#            </a>#}
{#            <a class="nav-link text-dark" href="/gallery/">#}
{#                <i class="bi bi-images me-2"></i>–ì–∞–ª–µ—Ä–µ—è#}
{#            </a>#}
{#            <a class="nav-link text-dark" href="/archive/">#}
{#                <i class="bi bi-archive me-2"></i>–ê—Ä—Ö–∏–≤#}
{#            </a>#}
{#            <a class="nav-link text-dark" href="/history/">#}
{#                <i class="bi bi-clock-history me-2"></i>–ò—Å—Ç–æ—Ä–∏—è#}
{#            </a>#}
{#        </div>#}
{#    </nav>#}
{##}
{#    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->#}
{#    <div class="card main-card">#}
{#        <div class="card-header card-header-custom text-center">#}
{#            <h1 class="h2 mb-0">#}
{#                <i class="bi bi-magic me-2"></i>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π AI#}
{#            </h1>#}
{#            <p class="mb-0 opacity-75">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</p>#}
{#        </div>#}
{##}
{#        <div class="card-body p-4">#}
{#            {% if error %}#}
{#                <div class="alert alert-danger d-flex align-items-center" role="alert">#}
{#                    <i class="bi bi-exclamation-triangle-fill me-2"></i>#}
{#                    {{ error }}#}
{#                </div>#}
{#            {% endif %}#}
{##}
{#            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->#}
{#            <div id="progress-container" class="mb-4" style="display: none;">#}
{#                <div class="d-flex justify-content-between mb-2">#}
{#                    <span id="status-text" class="fw-bold">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>#}
{#                    <span id="progress-text" class="fw-bold">0%</span>#}
{#                </div>#}
{#                <div class="progress progress-custom">#}
{#                    <div id="progress-bar" class="progress-bar progress-bar-custom" role="progressbar"></div>#}
{#                </div>#}
{#                <div class="text-center mt-2">#}
{#                    <small class="text-muted" id="progress-details">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...</small>#}
{#                </div>#}
{#            </div>#}
{##}
{#            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->#}
{#            <div id="result-container" class="text-center mb-4" style="display: none;">#}
{#                <div class="alert alert-success d-inline-flex align-items-center">#}
{#                    <i class="bi bi-check-circle-fill me-2"></i>#}
{#                    <span class="fw-bold">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!</span>#}
{#                </div>#}
{#                <div class="d-flex justify-content-center">#}
{#                    <img id="result-image" class="result-image img-fluid" style="max-width: 512px;">#}
{#                </div>#}
{#                <div class="mt-3">#}
{#                    <button class="btn btn-outline-primary me-2">#}
{#                        <i class="bi bi-download me-1"></i>–°–∫–∞—á–∞—Ç—å#}
{#                    </button>#}
{#                    <button class="btn btn-outline-success">#}
{#                        <i class="bi bi-share me-1"></i>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è#}
{#                    </button>#}
{#                </div>#}
{#            </div>#}
{##}
{#            <!-- –§–æ—Ä–º–∞ -->#}
{#            <form onsubmit="startGeneration(); return false;">#}
{#                {% csrf_token %}#}
{##}
{#                <div class="row">#}
{#                    <!-- –ü—Ä–æ–º–ø—Ç -->#}
{#                    <div class="col-12 mb-4">#}
{#                        <label class="form-label">üí¨ –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>#}
{#                        <textarea name="prompt" class="form-control prompt-textarea"#}
{#                                  placeholder="–û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏..."#}
{#                                  rows="4" required></textarea>#}
{#                    </div>#}
{##}
{#                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->#}
{#                    <div class="col-md-6 mb-3">#}
{#                        <label class="form-label">ü§ñ –ú–æ–¥–µ–ª—å AI</label>#}
{#                        <select name="model" class="form-select">#}
{#                            {% for key, model in models.items %}#}
{#                                <option value="{{ key }}">{{ model.name }}</option>#}
{#                            {% endfor %}#}
{#                        </select>#}
{#                    </div>#}
{##}
{#                    <div class="col-md-6 mb-3">#}
{#                        <label class="form-label">üìä –ö–∞—á–µ—Å—Ç–≤–æ</label>#}
{#                        <select name="quality" class="form-select">#}
{#                            {% for key, quality in quality_presets.items %}#}
{#                                <option value="{{ key }}">{{ quality.name }}#}
{#                                    ({{ quality.width }}x{{ quality.height }})#}
{#                                </option>#}
{#                            {% endfor %}#}
{#                        </select>#}
{#                    </div>#}
{##}
{#                    <div class="col-md-6 mb-3">#}
{#                        <label class="form-label">üö´ –ò—Å–∫–ª—é—á–µ–Ω–∏—è</label>#}
{#                        <select name="negative" class="form-select">#}
{#                            {% for key, negative in negative_prompts.items %}#}
{#                                <option value="{{ key }}">{{ negative.name }}</option>#}
{#                            {% endfor %}#}
{#                        </select>#}
{#                    </div>#}
{##}
{#                    <div class="col-md-6 mb-3 d-flex align-items-end">#}
{#                        <button type="submit" class="btn generate-btn w-100">#}
{#                            <i class="bi bi-lightning-fill me-2"></i>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ#}
{#                        </button>#}
{#                    </div>#}
{#                </div>#}
{#            </form>#}
{#        </div>#}
{#    </div>#}
{##}
{#    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–†–ï–ê–õ–ò–°–¢–ò–ß–ù–ê–Ø) -->#}
{#    <div class="row mt-4 text-center text-white">#}
{#        <div class="col-md-3 mb-3">#}
{#            <div class="p-3 rounded" style="background: rgba(255,255,255,0.1);">#}
{#                <i class="bi bi-image display-6 d-block mb-2"></i>#}
{#                <h4 class="stats-number" id="generated-count">{{ total_generated }}</h4>#}
{#                <small>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</small>#}
{#            </div>#}
{#        </div>#}
{#        <div class="col-md-3 mb-3">#}
{#            <div class="p-3 rounded" style="background: rgba(255,255,255,0.1);">#}
{#                <i class="bi bi-people display-6 d-block mb-2"></i>#}
{#                <h4 class="stats-number">3</h4>#}
{#                <small>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>#}
{#            </div>#}
{#        </div>#}
{#        <div class="col-md-3 mb-3">#}
{#            <div class="p-3 rounded" style="background: rgba(255,255,255,0.1);">#}
{#                <i class="bi bi-star display-6 d-block mb-2"></i>#}
{#                <h4 class="stats-number">2.1/5</h4>#}
{#                <small>–†–µ–π—Ç–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞</small>#}
{#            </div>#}
{#        </div>#}
{#        <div class="col-md-3 mb-3">#}
{#            <div class="p-3 rounded" style="background: rgba(255,255,255,0.1);">#}
{#                <i class="bi bi-lightning display-6 d-block mb-2"></i>#}
{#                <h4 class="stats-number">2:15</h4>#}
{#                <small>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</small>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#</div>#}
{##}
{#<!-- Bootstrap JS -->#}
{#<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>#}
{#<script>#}
{#    let isGenerating = false;#}
{#    let progressInterval;#}
{##}
{#    document.addEventListener('DOMContentLoaded', function () {#}
{#        // –û–ë–™–ï–î–ò–ù–ï–ù–ù–´–ô –ö–û–î –î–õ–Ø –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–Ø#}
{#        loadGeneratedCount();#}
{#        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL#}
{#        const urlParams = new URLSearchParams(window.location.search);#}
{#        const promptParam = urlParams.get('prompt');#}
{##}
{#        if (promptParam) {#}
{#            console.log('Found URL parameters, auto-filling form...');#}
{#            const promptText = decodeURIComponent(promptParam);#}
{#            const modelName = decodeURIComponent(urlParams.get('model') || '');#}
{#            const qualityValue = decodeURIComponent(urlParams.get('quality') || 'fast');#}
{#            const negativeValue = decodeURIComponent(urlParams.get('negative') || 'none');#}
{##}
{#            setTimeout(() => {#}
{#                const promptField = document.querySelector('textarea[name="prompt"]');#}
{#                const modelSelect = document.querySelector('select[name="model"]');#}
{#                const qualitySelect = document.querySelector('select[name="quality"]');#}
{#                const negativeSelect = document.querySelector('select[name="negative"]');#}
{##}
{#                if (promptField) {#}
{#                    promptField.value = promptText;#}
{##}
{#                    if (modelSelect && modelName) {#}
{#                        const modelOptions = modelSelect.options;#}
{#                        for (let i = 0; i < modelOptions.length; i++) {#}
{#                            if (modelOptions[i].textContent.trim() === modelName) {#}
{#                                modelSelect.selectedIndex = i;#}
{#                                break;#}
{#                            }#}
{#                        }#}
{#                    }#}
{##}
{#                    if (qualitySelect && qualityValue) qualitySelect.value = qualityValue;#}
{#                    if (negativeSelect && negativeValue) negativeSelect.value = negativeValue;#}
{##}
{#                    alert('‚úÖ –ü—Ä–æ–º–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏! –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"');#}
{#                    window.history.replaceState({}, document.title, window.location.pathname);#}
{#                }#}
{#            }, 500);#}
{#        }#}
{##}
{#        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –¥–ª—è –∞–≤—Ç–æ-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è#}
{#        const autoGenerateData = localStorage.getItem('autoGenerate');#}
{#        if (autoGenerateData) {#}
{#            const data = JSON.parse(autoGenerateData);#}
{#            if (Date.now() - data.timestamp < 10000) {#}
{#                console.log('Auto-filling form with data:', data);#}
{##}
{#                const promptField = document.querySelector('textarea[name="prompt"]');#}
{#                const modelSelect = document.querySelector('select[name="model"]');#}
{#                const qualitySelect = document.querySelector('select[name="quality"]');#}
{#                const negativeSelect = document.querySelector('select[name="negative"]');#}
{##}
{#                if (promptField) {#}
{#                    promptField.value = data.prompt;#}
{##}
{#                    if (modelSelect) {#}
{#                        const modelOptions = modelSelect.options;#}
{#                        for (let i = 0; i < modelOptions.length; i++) {#}
{#                            if (modelOptions[i].textContent.trim() === data.model) {#}
{#                                modelSelect.selectedIndex = i;#}
{#                                break;#}
{#                            }#}
{#                        }#}
{#                    }#}
{##}
{#                    if (qualitySelect) qualitySelect.value = data.quality;#}
{#                    if (negativeSelect) negativeSelect.value = data.negative;#}
{#                    showAutoFillNotification();#}
{#                }#}
{#            }#}
{#            localStorage.removeItem('autoGenerate');#}
{#        }#}
{##}
{#        // 3. –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫#}
{#        document.addEventListener('click', function (e) {#}
{#            if (e.target.closest('.btn-outline-primary')) {#}
{#                // –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ#}
{#                const resultImage = document.getElementById('result-image');#}
{#                if (resultImage && resultImage.src) {#}
{#                    const link = document.createElement('a');#}
{#                    link.href = resultImage.src;#}
{#                    link.download = 'ai-generated-image.png';#}
{#                    link.click();#}
{#                }#}
{#            }#}
{##}
{#            if (e.target.closest('.btn-outline-success')) {#}
{#                // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)#}
{#                const resultImage = document.getElementById('result-image');#}
{#                if (resultImage && resultImage.src) {#}
{#                    navigator.clipboard.writeText(resultImage.src).then(() => {#}
{#                        alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');#}
{#                    });#}
{#                }#}
{#            }#}
{#        });#}
{#    });#}
{##}
{#    function getCSRFToken() {#}
{#        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');#}
{#        return csrfToken ? csrfToken.value : '';#}
{#    }#}
{##}
{#    function startGeneration() {#}
{#        const form = document.querySelector('form');#}
{#        const formData = new FormData(form);#}
{##}
{#        // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –°–ö–û–†–û–°–¢–¨ –ü–†–û–ì–†–ï–°–°–ê –ü–û –ö–ê–ß–ï–°–¢–í–£#}
{#        const quality = formData.get('quality');#}
{#        let targetProgress = 70;#}
{##}
{#        if (quality === 'fast') targetProgress = 75;#}
{#        else if (quality === 'medium') targetProgress = 70;#}
{#        else if (quality === 'high') targetProgress = 65;#}
{##}
{#        // –ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –°–ï–õ–ï–ö–¢–û–†#}
{#        isGenerating = true;#}
{#        const navLinks = document.querySelectorAll('.nav-custom .nav-link'); // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û#}
{#        navLinks.forEach(link => {#}
{#            if (!link.classList.contains('active')) {#}
{#                link.style.opacity = '0.5';#}
{#                link.style.pointerEvents = 'none';#}
{#                link.title = '–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';#}
{#            }#}
{#        });#}
{##}
{#        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä#}
{#        const progressContainer = document.getElementById('progress-container');#}
{#        const progressBar = document.getElementById('progress-bar');#}
{#        const progressText = document.getElementById('progress-text');#}
{#        const statusText = document.getElementById('status-text');#}
{##}
{#        progressContainer.style.display = 'block';#}
{#        progressBar.style.width = '0%';#}
{#        progressText.textContent = '0%';#}
{#        statusText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';#}
{#        document.getElementById('result-container').style.display = 'none';#}
{##}
{#        // –£–ú–ù–´–ô –§–ò–ö–¢–ò–í–ù–´–ô –ü–†–û–ì–†–ï–°–°#}
{#        let fakeProgress = 0;#}
{#        const fakeProgressInterval = setInterval(() => {#}
{#            if (fakeProgress < targetProgress && isGenerating) {#}
{#                if (fakeProgress < 25) fakeProgress += 1.5;#}
{#                else if (fakeProgress < targetProgress - 10) fakeProgress += 0.3;#}
{#                else fakeProgress += 0.1;#}
{##}
{#                if (fakeProgress > targetProgress) fakeProgress = targetProgress;#}
{##}
{#                progressBar.style.width = fakeProgress + '%';#}
{#                progressText.textContent = Math.round(fakeProgress) + '%';#}
{##}
{#                if (fakeProgress < 10) statusText.textContent = 'üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';#}
{#                else if (fakeProgress < 25) statusText.textContent = 'üì• –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...';#}
{#                else statusText.textContent = 'üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';#}
{#            }#}
{#        }, 200);#}
{##}
{#        // –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –ì–ï–ù–ï–†–ê–¶–ò–ò#}
{#        fetch('/generate-ajax/', {#}
{#            method: 'POST',#}
{#            headers: {#}
{#                'Content-Type': 'application/json',#}
{#                'X-CSRFToken': getCSRFToken()#}
{#            },#}
{#            body: JSON.stringify({#}
{#                prompt: formData.get('prompt'),#}
{#                model: formData.get('model'),#}
{#                quality: formData.get('quality'),#}
{#                negative: formData.get('negative')#}
{#            })#}
{#        })#}
{#            .then(response => {#}
{#                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);#}
{#                return response.json();#}
{#            })#}
{#            .then(data => {#}
{#                clearInterval(fakeProgressInterval);#}
{##}
{#                let finalProgress = fakeProgress;#}
{#                const finalInterval = setInterval(() => {#}
{#                    if (finalProgress < 100) {#}
{#                        finalProgress += 5;#}
{#                        if (finalProgress > 100) finalProgress = 100;#}
{##}
{#                        progressBar.style.width = finalProgress + '%';#}
{#                        progressText.textContent = Math.round(finalProgress) + '%';#}
{#                        statusText.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';#}
{#                    } else {#}
{#                        clearInterval(finalInterval);#}
{#                        statusText.textContent = '‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';#}
{##}
{#                        // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ#}
{#                        isGenerating = false;#}
{#                        navLinks.forEach(link => {#}
{#                            link.style.opacity = '1';#}
{#                            link.style.pointerEvents = 'auto';#}
{#                            link.title = '';#}
{#                        });#}
{##}
{#                        if (data.success) {#}
{#                            document.getElementById('result-image').src = data.image_url;#}
{#                            document.getElementById('result-container').style.display = 'block';#}
{#                            updateGeneratedCount(); // ‚úÖ –ü–ï–†–ï–ú–ï–°–¢–ò–õ –°–Æ–î–ê - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ#}
{#                        } else {#}
{#                            statusText.textContent = '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';#}
{#                            alert('–û—à–∏–±–∫–∞: ' + data.error);#}
{#                        }#}
{#                    }#}
{#                }, 50);#}
{#            })#}
{#            .catch(error => {#}
{#                clearInterval(fakeProgressInterval);#}
{#                statusText.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';#}
{##}
{#                isGenerating = false;#}
{#                navLinks.forEach(link => {#}
{#                    link.style.opacity = '1';#}
{#                    link.style.pointerEvents = 'auto';#}
{#                    link.title = '';#}
{#                });#}
{#                alert('–û—à–∏–±–∫–∞: ' + error.message);#}
{#            });#}
{#    }#}
{##}
{#    async function loadGeneratedCount() {#}
{#        try {#}
{#            const response = await fetch('/api/stats/');#}
{#            if (!response.ok) {#}
{#                throw new Error('Network response was not ok');#}
{#            }#}
{#            const data = await response.json();#}
{#            document.getElementById('generated-count').textContent = data.total_generated;#}
{#        } catch (error) {#}
{#            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', error);#}
{#            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (47) –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å#}
{#        }#}
{#    }#}
{##}
{#    async function updateGeneratedCount() {#}
{#        try {#}
{#            const response = await fetch('/api/stats/increment/', {#}
{#                method: 'POST',#}
{#                headers: {#}
{#                    'X-CSRFToken': getCSRFToken(),#}
{#                    'Content-Type': 'application/json',#}
{#                }#}
{#            });#}
{##}
{#            if (!response.ok) {#}
{#                throw new Error('Network response was not ok');#}
{#            }#}
{##}
{#            const data = await response.json();#}
{#            document.getElementById('generated-count').textContent = data.total_generated;#}
{#        } catch (error) {#}
{#            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', error);#}
{#            // Fallback: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª#}
{#            const countElement = document.getElementById('generated-count');#}
{#            let currentCount = parseInt(countElement.textContent);#}
{#            countElement.textContent = currentCount + 1;#}
{#        }#}
{#    }#}
{##}
{#    function showAutoFillNotification() {#}
{#        const notification = document.createElement('div');#}
{#        notification.style.cssText = `#}
{#            position: fixed;#}
{#            top: 20px;#}
{#            right: 20px;#}
{#            padding: 15px 20px;#}
{#            background: #28a745;#}
{#            color: white;#}
{#            border-radius: 8px;#}
{#            font-weight: bold;#}
{#            z-index: 10000;#}
{#            animation: slideIn 0.3s ease-out;#}
{#            box-shadow: 0 4px 12px rgba(0,0,0,0.15);#}
{#        `;#}
{#        notification.textContent = '‚úÖ –ü—Ä–æ–º–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏! –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"';#}
{#        document.body.appendChild(notification);#}
{##}
{#        setTimeout(() => {#}
{#            notification.style.animation = 'slideOut 0.3s ease-in';#}
{#            setTimeout(() => {#}
{#                if (document.body.contains(notification)) {#}
{#                    document.body.removeChild(notification);#}
{#                }#}
{#            }, 300);#}
{#        }, 5000);#}
{#    }#}
{##}
{#    // –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è#}
{#    const notificationStyle = document.createElement('style');#}
{#    notificationStyle.textContent = `#}
{#        @keyframes slideIn {#}
{#            from { transform: translateX(100%); opacity: 0; }#}
{#            to { transform: translateX(0); opacity: 1; }#}
{#        }#}
{#        @keyframes slideOut {#}
{#            from { transform: translateX(0); opacity: 1; }#}
{#            to { transform: translateX(100%); opacity: 0; }#}
{#        }#}
{#    `;#}
{#    document.head.appendChild(notificationStyle);#}
{#</script>#}
{#</body>#}
{#</html>#}


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .nav-custom {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-custom .nav-link {
            border-radius: 12px;
            margin: 0 6px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #4a5568;
            padding: 12px 24px;
        }

        .nav-custom .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .nav-custom .nav-link:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .prompt-textarea {
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            resize: none;
            padding: 16px;
            font-size: 1rem;
        }

        .prompt-textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            color: white;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5a6fd8, #6a42a0);
        }

        .generate-btn:disabled {
            background: #a0aec0;
            transform: none;
            box-shadow: none;
        }

        .progress-custom {
            height: 25px;
            border-radius: 12px;
            background: #f8f9fa;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }

        .progress-bar-custom {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.4s ease;
        }

        .result-image {
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            border: 3px solid white;
        }

        .result-image:hover {
            transform: scale(1.03);
        }

        .form-label {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .card-header-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            position: relative;
            overflow: hidden;
        }

        .card-header-custom::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        }

        .card-header-custom h1 {
            font-weight: 800;
            font-size: 2.5rem;
            margin-bottom: 8px;
            position: relative;
        }

        .card-header-custom p {
            opacity: 0.9;
            font-size: 1.1rem;
            position: relative;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ff0000, #8535ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            color: white;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .stats-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-card {
            animation: slideUp 0.6s ease-out;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .alert-custom {
            border-radius: 12px;
            border: none;
            padding: 16px 20px;
            font-weight: 600;
        }

        .alert-success-custom {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .alert-danger-custom {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
        }
    </style>
</head>
<body class="gradient-bg">
<div class="container py-4">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="nav-custom">
        <div class="nav nav-pills justify-content-center">
            <a class="nav-link active" href="/">
                <i class="bi bi-palette me-2"></i>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä
            </a>
            <a class="nav-link text-dark" href="/gallery/">
                <i class="bi bi-images me-2"></i>–ì–∞–ª–µ—Ä–µ—è
            </a>
            <a class="nav-link text-dark" href="/archive/">
                <i class="bi bi-archive me-2"></i>–ê—Ä—Ö–∏–≤
            </a>
            <a class="nav-link text-dark" href="/history/">
                <i class="bi bi-clock-history me-2"></i>–ò—Å—Ç–æ—Ä–∏—è
            </a>
        </div>
    </nav>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="card main-card">
        <div class="card-header card-header-custom text-center">
            <h1 class="h2 mb-0">
                <i class="bi bi-magic me-2"></i>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π AI
            </h1>
            <p class="mb-0 opacity-75">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</p>
        </div>

        <div class="card-body p-4">
            {% if error %}
                <div class="alert alert-danger-custom alert-custom d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {{ error }}
                </div>
            {% endif %}

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
            <div id="progress-container" class="mb-4" style="display: none;">
                <div class="d-flex justify-content-between mb-2">
                    <span id="status-text" class="fw-bold">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                    <span id="progress-text" class="fw-bold">0%</span>
                </div>
                <div class="progress progress-custom">
                    <div id="progress-bar" class="progress-bar progress-bar-custom" role="progressbar"></div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted" id="progress-details">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...</small>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
            <div id="result-container" class="text-center mb-4" style="display: none;">
                <div class="alert alert-success-custom alert-custom d-inline-flex align-items-center mb-3">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span class="fw-bold">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!</span>
                </div>
                <div class="d-flex justify-content-center">
                    <img id="result-image" class="result-image img-fluid" style="max-width: 512px;">
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-primary me-2" onclick="downloadImage()">
                        <i class="bi bi-download me-1"></i>–°–∫–∞—á–∞—Ç—å
                    </button>
                    <button class="btn btn-outline-success" onclick="shareImage()">
                        <i class="bi bi-share me-1"></i>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                    </button>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ -->
            <form onsubmit="startGeneration(); return false;">
                {% csrf_token %}

                <div class="row">
                    <!-- –ü—Ä–æ–º–ø—Ç -->
                    <div class="col-12 mb-4">
                        <label class="form-label">üí¨ –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                        <textarea name="prompt" class="form-control prompt-textarea"
                                  placeholder="–û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏..."
                                  rows="4" required></textarea>
                    </div>

                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">ü§ñ –ú–æ–¥–µ–ª—å AI</label>
                        <select name="model" class="form-select">
                            {% for key, model in models.items %}
                                <option value="{{ key }}">{{ model.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">üìä –ö–∞—á–µ—Å—Ç–≤–æ</label>
                        <select name="quality" class="form-select">
                            {% for key, quality in quality_presets.items %}
                                <option value="{{ key }}">{{ quality.name }}
                                    ({{ quality.width }}x{{ quality.height }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">üö´ –ò—Å–∫–ª—é—á–µ–Ω–∏—è</label>
                        <select name="negative" class="form-select">
                            {% for key, negative in negative_prompts.items %}
                                <option value="{{ key }}">{{ negative.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <button type="submit" class="btn generate-btn w-100">
                            <i class="bi bi-lightning-fill me-2"></i>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mt-4 text-center">
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="bi bi-image stats-icon"></i>
                <h4 class="stats-number" id="generated-count">{{ total_generated }}</h4>
                <small>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="bi bi-people stats-icon"></i>
                <h4 class="stats-number">3</h4>
                <small>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="bi bi-star stats-icon"></i>
                <h4 class="stats-number">2.1/5</h4>
                <small>–†–µ–π—Ç–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="bi bi-lightning stats-icon"></i>
                <h4 class="stats-number">2:15</h4>
                <small>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</small>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let isGenerating = false;
    let progressInterval;
    let currentImageUrl = '';

    document.addEventListener('DOMContentLoaded', function () {
        // –û–ë–™–ï–î–ò–ù–ï–ù–ù–´–ô –ö–û–î –î–õ–Ø –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–Ø
        loadGeneratedCount();
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
        const urlParams = new URLSearchParams(window.location.search);
        const promptParam = urlParams.get('prompt');

        if (promptParam) {
            console.log('Found URL parameters, auto-filling form...');
            const promptText = decodeURIComponent(promptParam);
            const modelName = decodeURIComponent(urlParams.get('model') || '');
            const qualityValue = decodeURIComponent(urlParams.get('quality') || 'fast');
            const negativeValue = decodeURIComponent(urlParams.get('negative') || 'none');

            setTimeout(() => {
                const promptField = document.querySelector('textarea[name="prompt"]');
                const modelSelect = document.querySelector('select[name="model"]');
                const qualitySelect = document.querySelector('select[name="quality"]');
                const negativeSelect = document.querySelector('select[name="negative"]');

                if (promptField) {
                    promptField.value = promptText;

                    if (modelSelect && modelName) {
                        const modelOptions = modelSelect.options;
                        for (let i = 0; i < modelOptions.length; i++) {
                            if (modelOptions[i].textContent.trim() === modelName) {
                                modelSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    if (qualitySelect && qualityValue) qualitySelect.value = qualityValue;
                    if (negativeSelect && negativeValue) negativeSelect.value = negativeValue;

                    showAutoFillNotification('‚úÖ –ü—Ä–æ–º–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏! –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, 500);
        }

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –¥–ª—è –∞–≤—Ç–æ-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        const autoGenerateData = localStorage.getItem('autoGenerate');
        if (autoGenerateData) {
            const data = JSON.parse(autoGenerateData);
            if (Date.now() - data.timestamp < 10000) {
                console.log('Auto-filling form with data:', data);

                const promptField = document.querySelector('textarea[name="prompt"]');
                const modelSelect = document.querySelector('select[name="model"]');
                const qualitySelect = document.querySelector('select[name="quality"]');
                const negativeSelect = document.querySelector('select[name="negative"]');

                if (promptField) {
                    promptField.value = data.prompt;

                    if (modelSelect) {
                        const modelOptions = modelSelect.options;
                        for (let i = 0; i < modelOptions.length; i++) {
                            if (modelOptions[i].textContent.trim() === data.model) {
                                modelSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    if (qualitySelect) qualitySelect.value = data.quality;
                    if (negativeSelect) negativeSelect.value = data.negative;
                    showAutoFillNotification('‚úÖ –ü—Ä–æ–º–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏! –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"');
                }
            }
            localStorage.removeItem('autoGenerate');
        }
    });

    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }

    function startGeneration() {
        if (isGenerating) return;

        const form = document.querySelector('form');
        const formData = new FormData(form);

        // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –°–ö–û–†–û–°–¢–¨ –ü–†–û–ì–†–ï–°–°–ê –ü–û –ö–ê–ß–ï–°–¢–í–£
        const quality = formData.get('quality');
        let targetProgress = 70;

        if (quality === 'fast') targetProgress = 75;
        else if (quality === 'medium') targetProgress = 70;
        else if (quality === 'high') targetProgress = 65;

        // –ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ –ò –ö–ù–û–ü–ö–£
        isGenerating = true;
        const generateBtn = document.querySelector('.generate-btn');
        const navLinks = document.querySelectorAll('.nav-custom .nav-link');

        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';

        navLinks.forEach(link => {
            if (!link.classList.contains('active')) {
                link.style.opacity = '0.5';
                link.style.pointerEvents = 'none';
                link.title = '–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
            }
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const statusText = document.getElementById('status-text');

        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        statusText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';
        document.getElementById('result-container').style.display = 'none';

        // –£–ú–ù–´–ô –§–ò–ö–¢–ò–í–ù–´–ô –ü–†–û–ì–†–ï–°–°
        let fakeProgress = 0;
        const fakeProgressInterval = setInterval(() => {
            if (fakeProgress < targetProgress && isGenerating) {
                if (fakeProgress < 25) fakeProgress += 1.5;
                else if (fakeProgress < targetProgress - 10) fakeProgress += 0.3;
                else fakeProgress += 0.1;

                if (fakeProgress > targetProgress) fakeProgress = targetProgress;

                progressBar.style.width = fakeProgress + '%';
                progressText.textContent = Math.round(fakeProgress) + '%';

                if (fakeProgress < 10) statusText.textContent = 'üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
                else if (fakeProgress < 25) statusText.textContent = 'üì• –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...';
                else statusText.textContent = 'üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
            }
        }, 200);

        // –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –ì–ï–ù–ï–†–ê–¶–ò–ò
        fetch('/generate-ajax/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                prompt: formData.get('prompt'),
                model: formData.get('model'),
                quality: formData.get('quality'),
                negative: formData.get('negative')
            })
        })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                clearInterval(fakeProgressInterval);

                let finalProgress = fakeProgress;
                const finalInterval = setInterval(() => {
                    if (finalProgress < 100) {
                        finalProgress += 5;
                        if (finalProgress > 100) finalProgress = 100;

                        progressBar.style.width = finalProgress + '%';
                        progressText.textContent = Math.round(finalProgress) + '%';
                        statusText.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                    } else {
                        clearInterval(finalInterval);
                        statusText.textContent = '‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';

                        // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ –ò –ö–ù–û–ü–ö–£
                        isGenerating = false;
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = '<i class="bi bi-lightning-fill me-2"></i>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';

                        navLinks.forEach(link => {
                            link.style.opacity = '1';
                            link.style.pointerEvents = 'auto';
                            link.title = '';
                        });

                        if (data.success) {
                            currentImageUrl = data.image_url;
                            document.getElementById('result-image').src = data.image_url;
                            document.getElementById('result-container').style.display = 'block';
                            updateGeneratedCount();
                        } else {
                            statusText.textContent = '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
                            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                        }
                    }
                }, 50);
            })
            .catch(error => {
                clearInterval(fakeProgressInterval);
                statusText.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';

                isGenerating = false;
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="bi bi-lightning-fill me-2"></i>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';

                navLinks.forEach(link => {
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.title = '';
                });
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            });
    }

    function downloadImage() {
        if (currentImageUrl) {
            const link = document.createElement('a');
            link.href = currentImageUrl;
            link.download = 'ai-generated-image.png';
            link.click();
        }
    }

    function shareImage() {
        if (currentImageUrl) {
            navigator.clipboard.writeText(currentImageUrl).then(() => {
                showNotification('–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            }).catch(() => {
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 'error');
            });
        }
    }

    async function loadGeneratedCount() {
        try {
            const response = await fetch('/api/stats/');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            document.getElementById('generated-count').textContent = data.total_generated;
        } catch (error) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', error);
        }
    }

    async function updateGeneratedCount() {
        try {
            const response = await fetch('/api/stats/increment/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            document.getElementById('generated-count').textContent = data.total_generated;
        } catch (error) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', error);
            const countElement = document.getElementById('generated-count');
            let currentCount = parseInt(countElement.textContent);
            countElement.textContent = currentCount + 1;
        }
    }

    function showAutoFillNotification(message) {
        showNotification(message, 'success');
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${type === 'success' ? '#48bb78' : type === 'error' ? '#e53e3e' : '#667eea'};
            color: white;
            border-radius: 12px;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: none;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }

    // –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notificationStyle = document.createElement('style');
    notificationStyle.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(notificationStyle);
</script>
</body>
</html>