<!DOCTYPE html>
<html>
<head>
    <title>AI Image Generator</title>
    <style>
        .navbar {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .navbar a {
            text-decoration: none;
            padding: 10px 20px;
            margin-right: 10px;
            background: #007bff;
            color: white;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .navbar a:hover {
            background: #0056b3;
        }

        .navbar a.active {
            background: #0056b3;
        }
    </style>
</head>
<body>
<div class="navbar">
    <a href="/">üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</a>
    <a href="/gallery/" class="active">üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è</a>
    <a href="/archive/">üóÇÔ∏è –ê—Ä—Ö–∏–≤</a>
    <a href="/history/">üìù –ò—Å—Ç–æ—Ä–∏—è</a>
</div>
<h1>üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h1>

{% if error %}
    <div style="color: red;">‚ùå {{ error }}</div>
{% endif %}

<!-- –°—Ç–∞—Ä—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞) -->
{% if image_url %}
    <div>
        <h3>‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!</h3>
        <img src="{{ image_url }}" style="max-width: 512px;">
    </div>
{% endif %}


<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
<div id="progress-container" style="display: none; margin: 20px 0;">
    <div style="background: #f0f0f0; border-radius: 10px; overflow: hidden;">
        <div id="progress-bar" style="background: #4CAF50; height: 20px; width: 0%; transition: width 0.3s;"></div>
    </div>
    <div id="progress-text" style="text-align: center; font-weight: bold;">0%</div>
    <div id="status-text" style="text-align: center; color: #666; margin-top: 5px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
</div>

<!-- –ù–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
<div id="result-container" style="display: none;">
    <h3>‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!</h3>
    <img id="result-image" style="max-width: 512px;">
</div>

<form onsubmit="startGeneration(); return false;">
    {% csrf_token %}

    <label>–ú–æ–¥–µ–ª—å:</label><br>
    <select name="model">
        {% for key, model in models.items %}
            <option value="{{ key }}">{{ model.name }}</option>
        {% endfor %}
    </select><br><br>

    <label>–ö–∞—á–µ—Å—Ç–≤–æ:</label><br>
    <select name="quality">
        {% for key, quality in quality_presets.items %}
            <option value="{{ key }}">{{ quality.name }} ({{ quality.width }}x{{ quality.height }})</option>
        {% endfor %}
    </select><br><br>

    <label>–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã:</label><br>
    <select name="negative">
        {% for key, negative in negative_prompts.items %}
            <option value="{{ key }}">{{ negative.name }}</option>
        {% endfor %}
    </select><br><br>

    <textarea name="prompt" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º..." rows="4" cols="50"></textarea><br><br>

    <button type="submit">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
</form>

<script>
    let isGenerating = false;
    let progressInterval;

    document.addEventListener('DOMContentLoaded', function () {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
        const urlParams = new URLSearchParams(window.location.search);
        const promptParam = urlParams.get('prompt');
        const modelParam = urlParams.get('model');
        const qualityParam = urlParams.get('quality');
        const negativeParam = urlParams.get('negative');

        if (promptParam) {
            console.log('Found URL parameters, auto-filling form...');

            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const promptText = decodeURIComponent(promptParam);
            const modelName = decodeURIComponent(modelParam || '');
            const qualityValue = decodeURIComponent(qualityParam || 'fast');
            const negativeValue = decodeURIComponent(negativeParam || 'none');

            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ —á—Ç–æ–±—ã DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
            setTimeout(() => {
                const promptField = document.querySelector('textarea[name="prompt"]');
                const modelSelect = document.querySelector('select[name="model"]');
                const qualitySelect = document.querySelector('select[name="quality"]');
                const negativeSelect = document.querySelector('select[name="negative"]');

                if (promptField) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç
                    promptField.value = promptText;

                    // –ò—â–µ–º –º–æ–¥–µ–ª—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                    if (modelSelect && modelName) {
                        const modelOptions = modelSelect.options;
                        for (let i = 0; i < modelOptions.length; i++) {
                            if (modelOptions[i].textContent.trim() === modelName) {
                                modelSelect.selectedIndex = i;
                                console.log('Model found and selected:', modelName);
                                break;
                            }
                        }
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
                    if (qualitySelect && qualityValue) {
                        qualitySelect.value = qualityValue;
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
                    if (negativeSelect && negativeValue) {
                        negativeSelect.value = negativeValue;
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    alert('‚úÖ –ü—Ä–æ–º–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏! –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"');

                    // –û—á–∏—â–∞–µ–º URL —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–ª–æ—Å—å —Å–Ω–æ–≤–∞
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, 500);
        }
    });


    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }

    function startGeneration() {
    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –°–ö–û–†–û–°–¢–¨ –ü–†–û–ì–†–ï–°–°–ê –ü–û –ö–ê–ß–ï–°–¢–í–£
    const quality = formData.get('quality');
    let targetProgress = 70; // –¶–µ–ª–µ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
    
    if (quality === 'fast') {
        targetProgress = 75;
    } else if (quality === 'medium') {
        targetProgress = 70;
    } else if (quality === 'high') {
        targetProgress = 65; // –î–ª—è –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è —Ä–∞–Ω—å—à–µ
    }

    // –ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ
    isGenerating = true;
    const navLinks = document.querySelectorAll('.navbar a');
    navLinks.forEach(link => {
        if (!link.classList.contains('active')) {
            link.style.opacity = '0.5';
            link.style.pointerEvents = 'none';
            link.title = '–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
        }
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const statusText = document.getElementById('status-text');

    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.style.transition = 'width 0.3s ease';
    progressText.textContent = '0%';
    statusText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';

    document.getElementById('result-container').style.display = 'none';

    // –£–ú–ù–´–ô –§–ò–ö–¢–ò–í–ù–´–ô –ü–†–û–ì–†–ï–°–°
    let fakeProgress = 0;
    const fakeProgressInterval = setInterval(() => {
        if (fakeProgress < targetProgress && isGenerating) {
            // –ë–´–°–¢–†–´–ô –ü–†–û–ì–†–ï–°–° –î–û 25% (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏)
            if (fakeProgress < 25) {
                fakeProgress += 1.5;
            } 
            // –ú–ï–î–õ–ï–ù–ù–´–ô –ü–†–û–ì–†–ï–°–° –î–û –¶–ï–õ–ï–í–û–ì–û –ü–†–û–ì–†–ï–°–°–ê
            else if (fakeProgress < targetProgress - 10) {
                fakeProgress += 0.3;
            }
            // –û–ß–ï–ù–¨ –ú–ï–î–õ–ï–ù–ù–û –ü–û–î–•–û–î–ò–ú –ö –¶–ï–õ–ï–í–û–ú–£ –ü–†–û–ì–†–ï–°–°–£
            else {
                fakeProgress += 0.1;
            }
            
            // –ù–µ –¥–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å—É —É–π—Ç–∏ –¥–∞–ª—å—à–µ —Ü–µ–ª–µ–≤–æ–≥–æ
            if (fakeProgress > targetProgress) {
                fakeProgress = targetProgress;
            }
            
            progressBar.style.width = fakeProgress + '%';
            progressText.textContent = Math.round(fakeProgress) + '%';
            
            // –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–°–´
            if (fakeProgress < 10) {
                statusText.textContent = 'üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
            } else if (fakeProgress < 25) {
                statusText.textContent = 'üì• –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...';
            } else {
                statusText.textContent = 'üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
            }
        }
    }, 200);

    // –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê –ì–ï–ù–ï–†–ê–¶–ò–ò
    fetch('/generate-ajax/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            prompt: formData.get('prompt'),
            model: formData.get('model'),
            quality: formData.get('quality'),
            negative: formData.get('negative')
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ò–ù–¢–ï–†–í–ê–õ
        clearInterval(fakeProgressInterval);

        // –ü–õ–ê–í–ù–û –î–û–í–û–î–ò–ú –î–û 100% –ö–û–ì–î–ê –°–ï–†–í–ï–† –û–¢–í–ï–¢–ò–õ
        let finalProgress = fakeProgress;
        const finalInterval = setInterval(() => {
            if (finalProgress < 100) {
                finalProgress += 5;
                // –û–ì–†–ê–ù–ò–ß–ò–í–ê–ï–ú 100% –ß–¢–û–ë–´ –ù–ï –ë–´–õ–û 104%!
                if (finalProgress > 100) finalProgress = 100;
                
                progressBar.style.width = finalProgress + '%';
                progressText.textContent = Math.round(finalProgress) + '%'; // –û–∫—Ä—É–≥–ª—è–µ–º!
                statusText.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            } else {
                clearInterval(finalInterval);
                
                // –§–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ê–¢–£–°
                statusText.textContent = '‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';

                // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ
                isGenerating = false;
                navLinks.forEach(link => {
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.title = '';
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (data.success) {
                    document.getElementById('result-image').src = data.image_url;
                    document.getElementById('result-container').style.display = 'block';
                } else {
                    statusText.textContent = '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            }
        }, 50);
    })
    .catch(error => {
        // –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ò–ù–¢–ï–†–í–ê–õ –ü–†–ò –û–®–ò–ë–ö–ï
        clearInterval(fakeProgressInterval);
        statusText.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';

        // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ –ü–†–ò –û–®–ò–ë–ö–ï
        isGenerating = false;
        navLinks.forEach(link => {
            link.style.opacity = '1';
            link.style.pointerEvents = 'auto';
            link.title = '';
        });

        alert('–û—à–∏–±–∫–∞: ' + error.message);
    });
}
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ –≥–∞–ª–µ—Ä–µ–∏
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        const autoGenerateData = localStorage.getItem('autoGenerate');
        if (autoGenerateData) {
            const data = JSON.parse(autoGenerateData);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–≤–µ–∂–∏–µ (–Ω–µ —Å—Ç–∞—Ä—à–µ 10 —Å–µ–∫—É–Ω–¥)
            if (Date.now() - data.timestamp < 10000) {
                console.log('Auto-filling form with data:', data);

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                const promptField = document.querySelector('textarea[name="prompt"]');
                const modelSelect = document.querySelector('select[name="model"]');
                const qualitySelect = document.querySelector('select[name="quality"]');
                const negativeSelect = document.querySelector('select[name="negative"]');

                if (promptField) {
                    promptField.value = data.prompt;

                    // –ù–∞—Ö–æ–¥–∏–º –º–æ–¥–µ–ª—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                    if (modelSelect) {
                        const modelOptions = modelSelect.options;
                        for (let i = 0; i < modelOptions.length; i++) {
                            if (modelOptions[i].textContent.trim() === data.model) {
                                modelSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
                    if (qualitySelect) qualitySelect.value = data.quality;
                    if (negativeSelect) negativeSelect.value = data.negative;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                    showAutoFillNotification();

                    // –£–ë–†–ê–õ –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
                }
            }

            // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            localStorage.removeItem('autoGenerate');
        }
    });


    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏
    function showAutoFillNotification() {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #28a745;
            color: white;
            border-radius: 8px;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        notification.textContent = '‚úÖ –ü—Ä–æ–º–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏! –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"';
        document.body.appendChild(notification);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notificationStyle = document.createElement('style');
    notificationStyle.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(notificationStyle);
</script>
</body>
</html>