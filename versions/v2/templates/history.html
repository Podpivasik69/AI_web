<!DOCTYPE html>
<html>
<head>
    <title>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤</title>
    <style>
        .navbar {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .navbar a {
            text-decoration: none;
            padding: 10px 20px;
            margin-right: 10px;
            background: #007bff;
            color: white;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .navbar a:hover {
            background: #0056b3;
        }

        .navbar a.active {
            background: #0056b3;
        }

        .prompt-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #007bff;
        }

        .prompt-text {
            font-size: 16px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .prompt-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
            flex-wrap: wrap;
        }

        .meta-item {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .reuse-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .reuse-btn:hover {
            background: #218838;
        }

        .empty-history {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .filters {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .search-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
<div class="navbar">
    <a href="/">üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</a>
    <a href="/gallery/">üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è</a>
    <a href="/archive/">üóÇÔ∏è –ê—Ä—Ö–∏–≤</a>
    <a href="/history/" class="active">üìù –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤</a>
</div>

<h1>üìù –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤</h1>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
<div class="filters">
    <input type="text" id="searchInput" class="search-box" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–º–ø—Ç–∞–º..."
           onkeyup="filterPrompts()">
    <select id="modelFilter" onchange="filterPrompts()">
        <option value="all">–í—Å–µ –º–æ–¥–µ–ª–∏</option>
        <option value="Waifu Diffusion">Waifu Diffusion</option>
        <option value="MeinaMix">MeinaMix</option>
        <option value="Anything V5">Anything V5</option>
        <option value="Stable Diffusion v1.5">Stable Diffusion v1.5</option>
    </select>
    <select id="qualityFilter" onchange="filterPrompts()">
        <option value="all">–í—Å–µ –∫–∞—á–µ—Å—Ç–≤–∞</option>
        <option value="fast">–ë—ã—Å—Ç—Ä–æ–µ</option>
        <option value="medium">–°—Ä–µ–¥–Ω–µ–µ</option>
        <option value="high">–í—ã—Å–æ–∫–æ–µ</option>
    </select>
    <button onclick="clearFilters()">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
</div>

<!-- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ -->
<div id="prompts-list">
    {% if prompts %}
        {% for prompt in prompts %}
            <div class="prompt-card" data-model="{{ prompt.model_used }}" data-quality="{{ prompt.quality_used }}">
                <div class="prompt-text">
                    <strong>üìù –ü—Ä–æ–º–ø—Ç:</strong> {{ prompt.prompt_text }}
                </div>
                {% if prompt.translated_prompt %}
                    <div class="prompt-text" style="color: #666; font-style: italic;">
                        <strong>üåê –ü–µ—Ä–µ–≤–æ–¥:</strong> {{ prompt.translated_prompt }}
                    </div>
                {% endif %}
                <div class="prompt-meta">
                    <span class="meta-item">üïí {{ prompt.created_at|date:"d.m.Y H:i" }}</span>
                    <span class="meta-item">üé® {{ prompt.model_used }}</span>
                    <span class="meta-item">
                        {% if prompt.quality_used == 'fast' %}‚ö° –ë—ã—Å—Ç—Ä–æ–µ
                        {% elif prompt.quality_used == 'medium' %}üî∂ –°—Ä–µ–¥–Ω–µ–µ
                        {% elif prompt.quality_used == 'high' %}üî• –í—ã—Å–æ–∫–æ–µ
                        {% endif %}
                        <span class="meta-item">üî¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {{ prompt.use_count }} —Ä–∞–∑</span>
                        {% if prompt.negative_prompt_used != 'none' %}
                            <span class="meta-item">üö´ {{ prompt.negative_prompt_used }}</span>
                        {% endif %}
                </div>
                <button class="reuse-btn"
                        onclick="reusePrompt('{{ prompt.prompt_text }}', '{{ prompt.model_used }}', '{{ prompt.quality_used }}', '{{ prompt.negative_prompt_used }}')">
                    üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
            </div>
        {% endfor %}
    {% else %}
        <div class="empty-history">
            <h3>üìù –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</h3>
            <p>–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
        </div>
    {% endif %}
</div>

<script>
    function filterPrompts() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const modelFilter = document.getElementById('modelFilter').value;
        const qualityFilter = document.getElementById('qualityFilter').value;
        const prompts = document.querySelectorAll('.prompt-card');

        prompts.forEach(prompt => {
            const promptText = prompt.querySelector('.prompt-text').textContent.toLowerCase();
            const promptModel = prompt.getAttribute('data-model');
            const promptQuality = prompt.getAttribute('data-quality');

            const matchesSearch = promptText.includes(searchText);
            const matchesModel = modelFilter === 'all' || promptModel === modelFilter;
            const matchesQuality = qualityFilter === 'all' || promptQuality === qualityFilter;

            if (matchesSearch && matchesModel && matchesQuality) {
                prompt.style.display = 'block';
            } else {
                prompt.style.display = 'none';
            }
        });
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('modelFilter').value = 'all';
        document.getElementById('qualityFilter').value = 'all';
        filterPrompts();
    }

    function reusePrompt(promptText, modelUsed, qualityUsed, negativeUsed) {
        console.log('Reusing prompt:', promptText);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ë–ï–ó —Ñ–ª–∞–≥–∞ useAjax
        localStorage.setItem('autoGenerate', JSON.stringify({
            prompt: promptText,
            model: modelUsed,
            quality: qualityUsed,
            negative: negativeUsed,
            timestamp: Date.now()
            // –£–ë–†–ê–õ useAjax: true
        }));

        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        window.location.href = '/';
    }
    

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    document.addEventListener('DOMContentLoaded', function () {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL
        const urlParams = new URLSearchParams(window.location.search);
        const promptParam = urlParams.get('prompt');
        const modelParam = urlParams.get('model');
        const qualityParam = urlParams.get('quality');
        const negativeParam = urlParams.get('negative');

        if (promptParam && window.location.pathname === '/') {
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const promptText = decodeURIComponent(promptParam);
            const modelUsed = decodeURIComponent(modelParam);
            const qualityUsed = decodeURIComponent(qualityParam);
            const negativeUsed = decodeURIComponent(negativeParam);

            console.log('Auto-filling form with:', {promptText, modelUsed, qualityUsed, negativeUsed});

            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ —É—Å–ø–µ–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
            setTimeout(() => {
                const promptField = document.querySelector('textarea[name="prompt"]');
                const modelSelect = document.querySelector('select[name="model"]');
                const qualitySelect = document.querySelector('select[name="quality"]');
                const negativeSelect = document.querySelector('select[name="negative"]');

                if (promptField && modelSelect && qualitySelect && negativeSelect) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –ø—Ä–æ–º–ø—Ç–∞
                    promptField.value = promptText;

                    // –ù–∞—Ö–æ–¥–∏–º –∏ –≤—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—É—é –º–æ–¥–µ–ª—å
                    const modelOptions = modelSelect.options;
                    let modelFound = false;
                    for (let i = 0; i < modelOptions.length; i++) {
                        if (modelOptions[i].textContent.trim() === modelUsed) {
                            modelSelect.selectedIndex = i;
                            modelFound = true;
                            break;
                        }
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
                    if (['fast', 'medium', 'high'].includes(qualityUsed)) {
                        qualitySelect.value = qualityUsed;
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
                    if (['none', 'standard', 'anime'].includes(negativeUsed)) {
                        negativeSelect.value = negativeUsed;
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    if (modelFound) {
                        alert('–ü—Ä–æ–º–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏! –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"');
                    } else {
                        alert('–ü—Ä–æ–º–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"');
                    }

                    // –û—á–∏—â–∞–µ–º URL —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–ª–æ—Å—å —Å–Ω–æ–≤–∞
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    console.error('Form fields not found');
                }
            }, 100);
        }
    });
</script>
</body>
</html>