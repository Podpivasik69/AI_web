<!DOCTYPE html>
<html>
<head>
    <title>AI Image Generator</title>
    <style>
        .navbar {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .navbar a {
            text-decoration: none;
            padding: 10px 20px;
            margin-right: 10px;
            background: #007bff;
            color: white;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .navbar a:hover {
            background: #0056b3;
        }

        .navbar a.active {
            background: #0056b3;
        }
    </style>
</head>
<body>
<div class="navbar">
    <a href="/">üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</a>
    <a href="/gallery/" class="active">üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è</a>
    <a href="/archive/">üóÇÔ∏è –ê—Ä—Ö–∏–≤</a>
</div>
<h1>üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h1>

{% if error %}
    <div style="color: red;">‚ùå {{ error }}</div>
{% endif %}

<!-- –°—Ç–∞—Ä—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞) -->
{% if image_url %}
    <div>
        <h3>‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!</h3>
        <img src="{{ image_url }}" style="max-width: 512px;">
    </div>
{% endif %}


<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
<div id="progress-container" style="display: none; margin: 20px 0;">
    <div style="background: #f0f0f0; border-radius: 10px; overflow: hidden;">
        <div id="progress-bar" style="background: #4CAF50; height: 20px; width: 0%; transition: width 0.3s;"></div>
    </div>
    <div id="progress-text" style="text-align: center; font-weight: bold;">0%</div>
    <div id="status-text" style="text-align: center; color: #666; margin-top: 5px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
</div>

<!-- –ù–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
<div id="result-container" style="display: none;">
    <h3>‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!</h3>
    <img id="result-image" style="max-width: 512px;">
</div>

<form method="post">
    {% csrf_token %}

    <label>–ú–æ–¥–µ–ª—å:</label><br>
    <select name="model">
        {% for key, model in models.items %}
            <option value="{{ key }}">{{ model.name }}</option>
        {% endfor %}
    </select><br><br>

    <label>–ö–∞—á–µ—Å—Ç–≤–æ:</label><br>
    <select name="quality">
        {% for key, quality in quality_presets.items %}
            <option value="{{ key }}">{{ quality.name }} ({{ quality.width }}x{{ quality.height }})</option>
        {% endfor %}
    </select><br><br>

    <label>–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã:</label><br>
    <select name="negative">
        {% for key, negative in negative_prompts.items %}
            <option value="{{ key }}">{{ negative.name }}</option>
        {% endfor %}
    </select><br><br>

    <textarea name="prompt" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º..." rows="4" cols="50"></textarea><br><br>

    <button type="submit">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
</form>

<script>
    let isGenerating = false;
    let progressInterval;

    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }

    function startGeneration() {
        const form = document.querySelector('form');
        const formData = new FormData(form);

        // –ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ
        isGenerating = true;
        const navLinks = document.querySelectorAll('.navbar a');
        navLinks.forEach(link => {
            if (!link.classList.contains('active')) {
                link.style.opacity = '0.5';
                link.style.pointerEvents = 'none';
                link.title = '–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
            }
        });

        const quality = formData.get('quality');

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
        const qualitySettings = {
            'fast': {time: 15000, steps: 20, timePerStep: 750},
            'medium': {time: 35000, steps: 30, timePerStep: 1167},
            'high': {time: 60000, steps: 40, timePerStep: 1500}
        };

        const settings = qualitySettings[quality] || qualitySettings.medium;

        console.log('–ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, —à–∞–≥–∏:', settings.steps, '–≤—Ä–µ–º—è:', settings.time);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const statusText = document.getElementById('status-text');

        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        statusText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';

        document.getElementById('result-container').style.display = 'none';

        // –£–º–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        let animatedProgress = 0;
        let startTime = Date.now();
        let generationStartTime = null;
        let currentStep = 0;

        function updateProgressAnimation() {
            const elapsed = Date.now() - startTime;

            // –ü–µ—Ä–≤—ã–µ 25% –º–µ–¥–ª–µ–Ω–Ω–æ (–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏) - 5 —Å–µ–∫—É–Ω–¥
            if (elapsed < 5000) {
                animatedProgress = Math.min(25, (elapsed / 5000) * 25);
                statusText.textContent = 'üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...';
            }
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
            else {
                if (!generationStartTime) {
                    generationStartTime = Date.now();
                }

                const generationElapsed = Date.now() - generationStartTime;

                if (quality === 'high') {
                    const expectedTotalTime = 55000;
                    const timeProgress = Math.min(70, (generationElapsed / expectedTotalTime) * 70);
                    const maxStepProgress = currentStep * 1.75;
                    animatedProgress = 25 + Math.min(timeProgress, maxStepProgress);

                    const simulatedStep = Math.min(settings.steps, Math.floor(generationElapsed / 1400));
                    if (simulatedStep > currentStep) {
                        currentStep = simulatedStep;
                    }

                    statusText.textContent = `üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è... (—à–∞–≥ ${currentStep}/${settings.steps})`;
                } else {
                    const generationTime = settings.time - 5000;
                    const generationProgress = Math.min(70, (generationElapsed / generationTime) * 70);
                    animatedProgress = 25 + generationProgress;

                    const simulatedStep = Math.min(settings.steps, Math.floor((generationProgress / 70) * settings.steps));
                    statusText.textContent = `üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è... (—à–∞–≥ ${simulatedStep}/${settings.steps})`;
                }
            }

            // –§–ò–ö–°: –ù–µ –¥–∞–µ–º –ø—Ä–µ–≤—ã—Å–∏—Ç—å 95% –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
            animatedProgress = Math.min(95, animatedProgress);

            progressBar.style.width = animatedProgress + '%';
            progressText.textContent = Math.round(animatedProgress) + '%';
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        progressInterval = setInterval(updateProgressAnimation, 200);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô URL
        fetch('/generate-ajax/', {  // –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —ç—Ç–æ—Ç URL –µ—Å—Ç—å –≤ urls.py
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                prompt: formData.get('prompt'),
                model: formData.get('model'),
                quality: quality,
                negative: formData.get('negative')
            })
        })
            .then(response => response.json())
            .then(data => {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                clearInterval(progressInterval);

                // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ
                isGenerating = false;
                navLinks.forEach(link => {
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.title = '';
                });

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 100% –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                statusText.textContent = '‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (data.success) {
                    document.getElementById('result-image').src = data.image_url;
                    document.getElementById('result-container').style.display = 'block';
                } else {
                    statusText.textContent = '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                statusText.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';

                // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ù–ê–í–ò–ì–ê–¶–ò–Æ –ü–†–ò –û–®–ò–ë–ö–ï
                isGenerating = false;
                navLinks.forEach(link => {
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.title = '';
                });

                alert('–û—à–∏–±–∫–∞: ' + error.message);
            });
    }

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ –≥–∞–ª–µ—Ä–µ–∏
    document.addEventListener('DOMContentLoaded', function () {
        const galleryLink = document.querySelector('a[href*="gallery"]');
        if (galleryLink) {
            galleryLink.addEventListener('click', function (e) {
                if (isGenerating) {
                    e.preventDefault();
                    alert('‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ –≥–∞–ª–µ—Ä–µ—é');
                    return false;
                }
            });
        }

        // –¢–∞–∫–∂–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        window.addEventListener('beforeunload', function (e) {
            if (isGenerating) {
                e.preventDefault();
                e.returnValue = '–ò–¥–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
                return e.returnValue;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        document.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault();
            startGeneration();
        });
    });
</script>
</body>
</html>