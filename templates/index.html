<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .nav-custom {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1000;
        }

        .nav-custom .nav-link {
            border-radius: 12px;
            margin: 0 6px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #4a5568;
            padding: 12px 24px;
        }

        .nav-custom .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .nav-custom .nav-link:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        /* Стили для выпадающего меню пользователя */
        .user-dropdown {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
        }

        .user-avatar-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border: 2px solid #667eea;
        }

        .user-dropdown-toggle {
            background: transparent;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 8px 16px;
            color: #4a5568;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-dropdown-toggle:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .dropdown-menu {
            border: none;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            padding: 10px;
            margin-top: 10px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            min-width: 250px;
        }

        .dropdown-item {
            border-radius: 10px;
            padding: 12px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .user-info {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 10px;
        }

        .user-name {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .user-email {
            font-size: 0.85rem;
            color: #718096;
        }

        /* Остальные стили остаются такими же */
        .prompt-textarea {
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            resize: none;
            padding: 16px;
            font-size: 1rem;
        }

        .prompt-textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            color: white;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .card-header-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ff0000, #8535ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Центрирование навигационных ссылок */
        .nav-center {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .auth-btn {
            border: 2px solid #667eea;
            background: transparent;
            color: #667eea;
            padding: 8px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .auth-btn:hover {
            background: #667eea;
            color: white;
        }

        .auth-btn-primary {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body class="gradient-bg">
<div class="container py-4">
    <!-- Навигация -->
    <nav class="nav-custom">
        <div class="nav-center">
            <!-- Центрированные ссылки -->
            <div class="nav nav-pills">
                <a class="nav-link active" href="/">
                    <i class="bi bi-palette me-2"></i>Генератор
                </a>
                <a class="nav-link text-dark" href="/gallery/">
                    <i class="bi bi-images me-2"></i>Галерея
                </a>
                <a class="nav-link text-dark" href="/archive/">
                    <i class="bi bi-archive me-2"></i>Архив
                </a>
                <a class="nav-link text-dark" href="/history/">
                    <i class="bi bi-clock-history me-2"></i>История
                </a>
            </div>

            <!-- Блок пользователя справа -->
            <div class="user-dropdown">
                {% if user.is_authenticated %}
                    <div class="dropdown">
                        <button class="btn user-dropdown-toggle dropdown-toggle" type="button" id="userDropdown"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            {% if user.avatar %}
                                <img src="{{ user.avatar.url }}" class="user-avatar" alt="Аватар">
                            {% else %}
                                <div class="user-avatar-placeholder">
                                    {{ user.username|first|upper }}
                                </div>
                            {% endif %}
                            <span>{{ user.username }}</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li>
                                <div class="user-info">
                                    <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                                    <div class="user-email">{{ user.email|default:"Email не указан" }}</div>
                                </div>
                            </li>
                            <li><a class="dropdown-item" href="{% url 'profile' %}">
                                <i class="bi bi-person-circle"></i>Мой профиль
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'profile' %}">
                                <i class="bi bi-gear"></i>Настройки аккаунта
                            </a></li>
                            {% if user.is_staff %}
                            <li><a class="dropdown-item" href="{% url 'user_list' %}">
                                <i class="bi bi-people"></i>Управление пользователями
                            </a></li>
                            {% endif %}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}">
                                <i class="bi bi-box-arrow-right"></i>Выйти
                            </a></li>
                        </ul>
                    </div>
                {% else %}
                    <div class="auth-buttons">
                        <a href="{% url 'login' %}" class="auth-btn">Войти</a>
                        <a href="{% url 'register' %}" class="auth-btn auth-btn-primary">Регистрация</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Основная карточка -->
    <div class="card main-card">
        <div class="card-header card-header-custom text-center">
            <h1 class="h2 mb-0">
                <i class="bi bi-magic me-2"></i>Генератор изображений AI
            </h1>
            <p class="mb-0 opacity-75">Создавайте уникальные изображения с помощью искусственного интеллекта</p>
        </div>

        <div class="card-body p-4">
            {% if error %}
                <div class="alert alert-danger-custom alert-custom d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {{ error }}
                </div>
            {% endif %}

            <!-- Прогресс-бар -->
            <div id="progress-container" class="mb-4" style="display: none;">
                <div class="d-flex justify-content-between mb-2">
                    <span id="status-text" class="fw-bold">Подготовка...</span>
                    <span id="progress-text" class="fw-bold">0%</span>
                </div>
                <div class="progress progress-custom">
                    <div id="progress-bar" class="progress-bar progress-bar-custom" role="progressbar"></div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted" id="progress-details">Инициализация процесса генерации...</small>
                </div>
            </div>

            <!-- Результат -->
            <div id="result-container" class="text-center mb-4" style="display: none;">
                <div class="alert alert-success-custom alert-custom d-inline-flex align-items-center mb-3">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span class="fw-bold">Изображение сгенерировано!</span>
                </div>
                <div class="d-flex justify-content-center">
                    <img id="result-image" class="result-image img-fluid" style="max-width: 512px;">
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-primary me-2" onclick="downloadImage()">
                        <i class="bi bi-download me-1"></i>Скачать
                    </button>
                    <button class="btn btn-outline-success" onclick="shareImage()">
                        <i class="bi bi-share me-1"></i>Поделиться
                    </button>
                </div>
            </div>

            <!-- Форма -->
            <form onsubmit="startGeneration(); return false;">
                {% csrf_token %}

                <div class="row">
                    <!-- Промпт -->
                    <div class="col-12 mb-4">
                        <label class="form-label">💬 Описание изображения</label>
                        <textarea name="prompt" class="form-control prompt-textarea"
                                  placeholder="Опишите детально что вы хотите увидеть на изображении..."
                                  rows="4" required></textarea>
                    </div>

                    <!-- Настройки -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">🤖 Модель AI</label>
                        <select name="model" class="form-select">
                            {% for key, model in models.items %}
                                <option value="{{ key }}">{{ model.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">📊 Качество</label>
                        <select name="quality" class="form-select">
                            {% for key, quality in quality_presets.items %}
                                <option value="{{ key }}">{{ quality.name }}
                                    ({{ quality.width }}x{{ quality.height }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">🚫 Исключения</label>
                        <select name="negative" class="form-select">
                            {% for key, negative in negative_prompts.items %}
                                <option value="{{ key }}">{{ negative.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <button type="submit" class="btn generate-btn w-100">
                            <i class="bi bi-lightning-fill me-2"></i>Сгенерировать изображение
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mt-4 text-center">
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="bi bi-image stats-icon"></i>
                <h4 class="stats-number" id="generated-count">{{ total_generated }}</h4>
                <small>Сгенерировано изображений</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="bi bi-people stats-icon"></i>
                <h4 class="stats-number">3</h4>
                <small>Активных пользователей</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="bi bi-star stats-icon"></i>
                <h4 class="stats-number">2.1/5</h4>
                <small>Рейтинг качества</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="bi bi-lightning stats-icon"></i>
                <h4 class="stats-number">2:15</h4>
                <small>Среднее время генерации</small>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let isGenerating = false;
    let progressInterval;
    let currentImageUrl = '';

    document.addEventListener('DOMContentLoaded', function () {
        // ОБЪЕДИНЕННЫЙ КОД ДЛЯ АВТОЗАПОЛНЕНИЯ
        loadGeneratedCount();
        // 1. Проверяем параметры URL
        const urlParams = new URLSearchParams(window.location.search);
        const promptParam = urlParams.get('prompt');

        if (promptParam) {
            console.log('Found URL parameters, auto-filling form...');
            const promptText = decodeURIComponent(promptParam);
            const modelName = decodeURIComponent(urlParams.get('model') || '');
            const qualityValue = decodeURIComponent(urlParams.get('quality') || 'fast');
            const negativeValue = decodeURIComponent(urlParams.get('negative') || 'none');

            setTimeout(() => {
                const promptField = document.querySelector('textarea[name="prompt"]');
                const modelSelect = document.querySelector('select[name="model"]');
                const qualitySelect = document.querySelector('select[name="quality"]');
                const negativeSelect = document.querySelector('select[name="negative"]');

                if (promptField) {
                    promptField.value = promptText;

                    if (modelSelect && modelName) {
                        const modelOptions = modelSelect.options;
                        for (let i = 0; i < modelOptions.length; i++) {
                            if (modelOptions[i].textContent.trim() === modelName) {
                                modelSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    if (qualitySelect && qualityValue) qualitySelect.value = qualityValue;
                    if (negativeSelect && negativeValue) negativeSelect.value = negativeValue;

                    showAutoFillNotification('✅ Промпт загружен из истории! Нажмите "Сгенерировать изображение"');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, 500);
        }

        // 2. Проверяем localStorage для авто-заполнения
        const autoGenerateData = localStorage.getItem('autoGenerate');
        if (autoGenerateData) {
            const data = JSON.parse(autoGenerateData);
            if (Date.now() - data.timestamp < 10000) {
                console.log('Auto-filling form with data:', data);

                const promptField = document.querySelector('textarea[name="prompt"]');
                const modelSelect = document.querySelector('select[name="model"]');
                const qualitySelect = document.querySelector('select[name="quality"]');
                const negativeSelect = document.querySelector('select[name="negative"]');

                if (promptField) {
                    promptField.value = data.prompt;

                    if (modelSelect) {
                        const modelOptions = modelSelect.options;
                        for (let i = 0; i < modelOptions.length; i++) {
                            if (modelOptions[i].textContent.trim() === data.model) {
                                modelSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    if (qualitySelect) qualitySelect.value = data.quality;
                    if (negativeSelect) negativeSelect.value = data.negative;
                    showAutoFillNotification('✅ Промпт загружен из истории! Настройте параметры и нажмите "Сгенерировать изображение"');
                }
            }
            localStorage.removeItem('autoGenerate');
        }
    });

    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }

    function startGeneration() {
        if (isGenerating) return;

        const form = document.querySelector('form');
        const formData = new FormData(form);

        // ОПРЕДЕЛЯЕМ СКОРОСТЬ ПРОГРЕССА ПО КАЧЕСТВУ
        const quality = formData.get('quality');
        let targetProgress = 70;

        if (quality === 'fast') targetProgress = 75;
        else if (quality === 'medium') targetProgress = 70;
        else if (quality === 'high') targetProgress = 65;

        // БЛОКИРУЕМ НАВИГАЦИЮ И КНОПКУ
        isGenerating = true;
        const generateBtn = document.querySelector('.generate-btn');
        const navLinks = document.querySelectorAll('.nav-custom .nav-link');

        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Генерация...';

        navLinks.forEach(link => {
            if (!link.classList.contains('active')) {
                link.style.opacity = '0.5';
                link.style.pointerEvents = 'none';
                link.title = 'Дождитесь завершения генерации';
            }
        });

        // Показываем прогресс-бар
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const statusText = document.getElementById('status-text');

        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
        statusText.textContent = 'Подготовка...';
        document.getElementById('result-container').style.display = 'none';

        // УМНЫЙ ФИКТИВНЫЙ ПРОГРЕСС
        let fakeProgress = 0;
        const fakeProgressInterval = setInterval(() => {
            if (fakeProgress < targetProgress && isGenerating) {
                if (fakeProgress < 25) fakeProgress += 1.5;
                else if (fakeProgress < targetProgress - 10) fakeProgress += 0.3;
                else fakeProgress += 0.1;

                if (fakeProgress > targetProgress) fakeProgress = targetProgress;

                progressBar.style.width = fakeProgress + '%';
                progressText.textContent = Math.round(fakeProgress) + '%';

                if (fakeProgress < 10) statusText.textContent = '🔄 Инициализация...';
                else if (fakeProgress < 25) statusText.textContent = '📥 Загрузка модели...';
                else statusText.textContent = '🎨 Генерация изображения...';
            }
        }, 200);

        // ОТПРАВКА ЗАПРОСА ГЕНЕРАЦИИ
        fetch('/generate-ajax/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                prompt: formData.get('prompt'),
                model: formData.get('model'),
                quality: formData.get('quality'),
                negative: formData.get('negative')
            })
        })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                clearInterval(fakeProgressInterval);

                let finalProgress = fakeProgress;
                const finalInterval = setInterval(() => {
                    if (finalProgress < 100) {
                        finalProgress += 5;
                        if (finalProgress > 100) finalProgress = 100;

                        progressBar.style.width = finalProgress + '%';
                        progressText.textContent = Math.round(finalProgress) + '%';
                        statusText.textContent = '💾 Сохранение...';
                    } else {
                        clearInterval(finalInterval);
                        statusText.textContent = '✅ Генерация завершена';

                        // РАЗБЛОКИРУЕМ НАВИГАЦИЮ И КНОПКУ
                        isGenerating = false;
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = '<i class="bi bi-lightning-fill me-2"></i>Сгенерировать изображение';

                        navLinks.forEach(link => {
                            link.style.opacity = '1';
                            link.style.pointerEvents = 'auto';
                            link.title = '';
                        });

                        if (data.success) {
                            currentImageUrl = data.image_url;
                            document.getElementById('result-image').src = data.image_url;
                            document.getElementById('result-container').style.display = 'block';
                            updateGeneratedCount();
                        } else {
                            statusText.textContent = '❌ Ошибка генерации';
                            showNotification('Ошибка: ' + data.error, 'error');
                        }
                    }
                }, 50);
            })
            .catch(error => {
                clearInterval(fakeProgressInterval);
                statusText.textContent = '❌ Ошибка соединения';

                isGenerating = false;
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="bi bi-lightning-fill me-2"></i>Сгенерировать изображение';

                navLinks.forEach(link => {
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.title = '';
                });
                showNotification('Ошибка: ' + error.message, 'error');
            });
    }

    function downloadImage() {
        if (currentImageUrl) {
            const link = document.createElement('a');
            link.href = currentImageUrl;
            link.download = 'ai-generated-image.png';
            link.click();
        }
    }

    function shareImage() {
        if (currentImageUrl) {
            navigator.clipboard.writeText(currentImageUrl).then(() => {
                showNotification('Ссылка на изображение скопирована в буфер обмена!', 'success');
            }).catch(() => {
                showNotification('Не удалось скопировать ссылку', 'error');
            });
        }
    }

    async function loadGeneratedCount() {
        try {
            const response = await fetch('/api/stats/');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            document.getElementById('generated-count').textContent = data.total_generated;
        } catch (error) {
            console.log('Не удалось загрузить статистику:', error);
        }
    }

    async function updateGeneratedCount() {
        try {
            const response = await fetch('/api/stats/increment/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            document.getElementById('generated-count').textContent = data.total_generated;
        } catch (error) {
            console.log('Не удалось обновить статистику:', error);
            const countElement = document.getElementById('generated-count');
            let currentCount = parseInt(countElement.textContent);
            countElement.textContent = currentCount + 1;
        }
    }

    function showAutoFillNotification(message) {
        showNotification(message, 'success');
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${type === 'success' ? '#48bb78' : type === 'error' ? '#e53e3e' : '#667eea'};
            color: white;
            border-radius: 12px;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: none;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }

    // Стили для анимации уведомления
    const notificationStyle = document.createElement('style');
    notificationStyle.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(notificationStyle);
</script>
</body>
</html>